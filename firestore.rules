rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 管理者かどうかを判定する補助関数 (Google Auth 用に維持)
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/config/admin) &&
             (request.auth.token.email in get(/databases/$(database)/documents/config/admin).data.authorizedEmails);
    }

    // 全ての設定（管理者、コンテンツ、OGP、データ）：読み取りはログインチェック用に維持、書き込みは管理者のみ
    match /config/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // その他のドキュメント
    match /{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 参加者登録・管理
    match /participants/{email} {
      // 閲覧：ログイン済みユーザーなら誰でも可能（他者の概要を確認するため）
      allow read: if request.auth != null;
      
      // 作成：ログイン済み、かつ自身のメールアドレスでの登録、かつ必須項目あり（role は任意）
      allow create: if request.auth != null && 
                       request.auth.token.email == email &&
                       request.resource.data.keys().hasAll(['lastName', 'firstName', 'email', 'company', 'organization', 'dataConsent', 'createdAt']) &&
                       request.resource.data.email == email;
      
      // 更新：自身のデータ、または「いいね」の更新のみ可能
      allow update: if request.auth != null && 
                       (request.auth.token.email == email || 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'likeCount', 'likedBy', 'commentCount']));
      
      // 削除：自身または管理者のみ
      allow delete: if request.auth != null && 
                       (request.auth.token.email == email || isAdmin());

      // コメントサブコレクション
      match /comments/{commentId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && 
                         request.resource.data.userEmail == request.auth.token.email;
        allow update, delete: if request.auth != null && 
                                 (resource.data.userEmail == request.auth.token.email || isAdmin());
      }
    }
  }
}
